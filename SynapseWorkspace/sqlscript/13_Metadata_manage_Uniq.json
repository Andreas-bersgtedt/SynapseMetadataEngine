{
	"name": "13_Metadata_manage_Uniq",
	"properties": {
		"folder": {
			"name": "Run Me 2nd"
		},
		"content": {
			"query": "CREATE PROC [Metadata].[sp_manage_UniqueKey_Attribute] @EntityId [bigint],@RowIdColumn [VARCHAR](MAX),@ACTION [VARCHAR](10) AS\nBEGIN\n\t/*\n--DEBUG\nDECLARE @EntityId bigint , @DeltaColumn VARCHAR(MAX), @RowIdColumn VARCHAR(MAX), @DeltaOperator VARCHAR(MAX), @DeltaSeedValue VARCHAR(MAX)\n\n\nSET @EntityId = 477\nSET  @RowIdColumn = 'rowguid'\n--SET  @DeltaColumn = 'ModifiedDate'\n--SET  @DeltaOperator = '>='\n--DEBUG\n*/\n\t/*DECLARE CONSTANTS*/\n\tDECLARE @RIDKEY VARCHAR(MAX) = 'EntityRowIdentifier'\n\t/*Declare Globals*/\n\tDECLARE @DataSetID BIGINT\n\t\t,@DeltaDataType VARCHAR(MAX)\n\n\tSET @DataSetID = (\n\t\t\tSELECT DataSetID\n\t\t\tFROM [Metadata].[Entity]\n\t\t\tWHERE id = @EntityId\n\t\t\t)\n\n\t/*Flush Previous Data*/\n\tIF @ACTION = 'D'\n\t\tDELETE\n\t\tFROM [Metadata].[Attribute]\n\t\tWHERE ID IN (\n\t\t\t\tSELECT v.id\n\t\t\t\tFROM [Metadata].[Attribute] v\n\t\t\t\tWHERE v.[Key] = @RIDKEY\n\t\t\t\t\tAND v.Entityid = @EntityId\n\t\t\t\t)\n\n\tINSERT INTO [Metadata].[Attribute] (\n\t\t[EntityId]\n\t\t,[ObjectId]\n\t\t,[MetadataObjectHash]\n\t\t,[DataSetID]\n\t\t,[KEY]\n\t\t,[Value]\n\t\t,[KeyValueDataType]\n\t\t,[KeyValueRefreshDate]\n\t\t,[RecordProcessTimestamp]\n\t\t,[CreatedUTCTimestamp]\n\t\t)\n\tSELECT *\n\tFROM (\n\t\tSELECT [EntityId] = @EntityId\n\t\t\t,[ObjectId] = NULL\n\t\t\t,[MetadataObjectHash] = NULL\n\t\t\t,[DataSetID] = @DataSetID\n\t\t\t,[KEY] = @RIDKEY\n\t\t\t,[Value] = @RowIdColumn\n\t\t\t,[KeyValueDataType] = 'String'\n\t\t\t,[KeyValueRefreshDate] = getutcdate()\n\t\t\t,[RecordProcessTimestamp] = getutcdate()\n\t\t\t,[CreatedUTCTimestamp] = getutcdate()\n\t\t) AS XX\n\n\tSELECT v.*\n\tFROM [Metadata].[Attribute] v\n\tWHERE v.[Key] = @RIDKEY\n\t\tAND v.Entityid = @EntityId\nEND",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "mesqldw",
				"databaseName": "mesqldw"
			}
		},
		"type": "SqlQuery"
	}
}