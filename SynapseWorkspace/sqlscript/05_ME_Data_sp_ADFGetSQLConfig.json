{
	"name": "05_ME_Data_sp_ADFGetSQLConfig",
	"properties": {
		"folder": {
			"name": "Run Me 2nd"
		},
		"content": {
			"query": "CREATE PROC [ME_Data].[sp_ADFGetSQLConfig] @DataSetType [VARCHAR](100),@RunGroupCode [VARCHAR](20) AS\nBEGIN\n\nSELECT\td.[DataSetType], \n\t\tDBServerName=C.[ConnectionString],\n\t\tDBName=C.[ConnectionName],\n\t\tSQLKVName=C.[ConnectionKVSecret]\n\t\t,SqlUserName=C.[ConnectionKVSecret]\n       ,D.[DataSetName]\n      ,D.[SchemaName]\n      ,DLContainer=LOWER(E.TargetLake)\n\t  ,DLFolder=LOWER(E.LakeFolder)\n\t  ,DLFileName=LOWER(CONCAT(D.[SchemaName],'_',D.[DataSetName]))\n      ,SQLQuery=CONVERT(NVARCHAR(MAX),'SELECT '+COLS.Cols/*[ME_Config].[fnGetRMDBSQuerySelectColumnNames](E.Id)*/+' FROM ['+E.[SchemaName]+'].['+E.[Name]+']')\n      \nFROM\t[ME_Config].[DataSet] D\n\t\tINNER JOIN [ME_Config].[Connection] C ON D.[ConnectionId]=C.id\n\t\tINNER JOIN Metadata.Entity E ON D.Id=E.DatasetId AND D.[IsEnabled]=1\n\t\tINNER JOIN (   \n\t\t\t\t\tSELECT Cols=CONVERT(NVARCHAR(MAX),(ISNULL\t(\n\t\t\t\t\t\tSTRING_AGG('['+REPLACE([MetadataObjectName],' ','_')+']=['+[MetadataObjectName]+']',',')\n\t\t\t\t\t\tWITHIN GROUP ( ORDER BY [MetadataObjectOrder]  ASC  )\n\t\t\t\t\t\t,'*'\n\t\t\t\t\t\t))),EntityID\n\t\t\t\t\tFROM MEtadata.[object] \n\t\t\t\t\tWhere EntityID IN (\n\t\t\t\t\tSELECT DISTINCT EntityID \n\t\t\t\t\tFROM MEtadata.[object] \n\t\t\t\t\twhere [MetadataObjectName] LIKE '% %'\n\t\t\t\t\t\t\t\t\t\t) \n\t\t\t\t\t\t\t\t\t\tGROUP BY EntityID\n\t\t\t\t\t \n\t\t\t\t\t) AS COLS ON COLS.EntityID=E.Id\n\nWHERE\tD.DataSetType=@DataSetType\n\t\tAND (D.RunGroupCode=@RunGroupCode OR @RunGroupCode='-1')\n\t\tAND D.IsEnabled < 2\n\nEND\nGO\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "mesqldw",
				"databaseName": "mesqldw"
			}
		},
		"type": "SqlQuery"
	}
}