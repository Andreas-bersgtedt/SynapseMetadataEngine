{
	"name": "11_DynamicRMDBS_discoverSQL",
	"properties": {
		"folder": {
			"name": "Run Me 2nd"
		},
		"content": {
			"query": "CREATE PROC [ME_Config].[sp_GENERATE_DynamicRMDBS_discoverSQL] AS\nBEGIN\nSELECT SQLQuery=REPLACE('\nSELECT ¬'+C.Connectiontype+'¬ AS DataSetType,¬999¬ AS RunGroupCode,TABLE_NAME AS DataSetName,TABLE_SCHEMA AS SchemaName\n,¬RAW¬ AS TargetLake,¬'+CONVERT(VARCHAR(20),C.iD)+'¬ AS ConnectionId\n,0 AS IsEnabled\n  FROM INFORMATION_SCHEMA.TABLES\n  WHERE TABLE_TYPE=¬BASE TABLE¬\n  '+CASE WHEN C.Connectiontype='MYSQL' \n\t\tTHEN 'AND TABLE_SCHEMA NOT IN (¬mysql¬,¬performance_schema¬,¬sys¬) '\n\t\tELSE '' END\n,'¬','''')\n  ,[DataSetType]=C.Connectiontype, \n\t\tDBServerName=C.[ConnectionString],\n\t\tDBName=C.[ConnectionName],\n\t\tSQLKVName=C.[ConnectionKVSecret]\n\t\t,SqlUserName=C.[ConnetionUserName]\n\t\t  ,DLContainer='metadata'\n\t  ,DLFolder='me_config_dataset'\n\t  ,DLFileName=LOWER(CONCAT(C.[ConnectionName],'_',C.[ConnectionKVSecret]))\n  FROM [ME_Config].[Connection] C\n  Where C.id not in (SELECT ConnectionId From [ME_Config].[DataSet])\n  and C.Connectiontype IN ('MSSQL','MYSQL')\n\n\n\n  END\nGO\n\n  CREATE PROC [ME_Config].[sp_insertActivityEvent] @EventSource [varchar](50),@EventSourceID [varchar](100),@EventActivityName [varchar](100),@EventMessage [varchar](1000) AS\nBEGIN\nDECLARE @UTCDATE AS DATETIME\nSET @UTCDATE =  getUTCDATE()\n\nINSERT INTO [ME_Config].[ActivityLog]\n           ([EventSource]\n           ,[EventSourceID]\n           ,[EventActivityName]\n           ,[EventUTCTimestamp]\n           ,[EventMessage])\n     VALUES\n           (@EventSource,\n           @EventSourceID,\n           @EventActivityName,\n           @UTCDATE,\n           @EventMessage\n\t\t   )\nEND\nGO\n\nCREATE PROC [ME_Config].[sp_LoadPrimeMetadata] AS\nBEGIN\n\t/*DEBUG\n\t\tSET @PARTITIONSTRING='2021/01/07/15/23'\n\t\tSET @DatasetID=25\n*/\n\t/*DECLARE GLOBALS*/\n\tDECLARE @STORAGE_ACCOUNT VARCHAR(500)\n\t\n\t\n\t/*SET GLOBAL PARAMETERS*/\n\tSET @STORAGE_ACCOUNT =(SELECT TOP 1 AttributeValue\tFROM ME_Config.GLOBALS WHERE [Attribute]='STORAGE_ACCOUNT')\n\n\t/*DECLARE LOCAL PARAMETERS*/\n\tDECLARE @SQLCOPYINTO VARCHAR(MAX);\n\tDECLARE @SourceConnnectionName VARCHAR(250)\n\t\n\n\t/*Get Source Database / Connection Name for use in target table name*/\n\tSET @SourceConnnectionName = ('https://'+@STORAGE_ACCOUNT+'.dfs.core.windows.net/metadata/me_config_dataset/*.parquet')\n\t\n\n\n\t/*Ensure Stage schema exists as defined in MF_Config.Globals*/\n\t\n\t/*Build out main metadata for dynamic SQL*/\n\n/*Build out Copy Into Statement*/\n\tSET @SQLCOPYINTO = (REPLACE('COPY INTO dbo.tbdxxxxx\n(DATASETTYPE 1, RUNGROUPCODE 2, DATASETNAME 3, SCHEMANAME 4, TARGETLAKE 5, CONNECTIONID 6, ISENABLED 7)\n  \n  FROM  ¬'+@SourceConnnectionName+ '¬\n  WITH\n(\n\tFILE_TYPE = ¬PARQUET¬\n\t,MAXERRORS = 0\n\t,IDENTITY_INSERT = ¬OFF¬\n)\n\n  ', '¬', '''')\n\t\t\n\t\t\t)\n\t\n\t/*Build Out Drop and Recreate of StageTable*/\n\tPRINT @SQLCOPYINTO\n\n\nBEGIN TRY DROP TABLE dbo.tbdxxxxx END TRY BEGIN CATCH PRINT '' END CATCH\nIF NOT EXISTS (SELECT * FROM sys.objects WHERE NAME = 'tbdxxxxx' AND TYPE = 'U')\nCREATE TABLE dbo.tbdxxxxx\n\t(\n\t [DATASETTYPE] nvarchar(4000),\n\t [RUNGROUPCODE] nvarchar(4000),\n\t [DATASETNAME] nvarchar(4000),\n\t [SCHEMANAME] nvarchar(4000),\n\t [TARGETLAKE] nvarchar(4000),\n\t [CONNECTIONID] nvarchar(4000),\n\t [ISENABLED] INT\n\t)\nWITH\n\t(\n\tDISTRIBUTION = ROUND_ROBIN,\n\t HEAP\n\t);\n\n\n\n\n\n\tEXEC (@SQLCOPYINTO)\n\n\tINSERT INTO [ME_Config].[DataSet]([DataSetType]\n      ,[RunGroupCode]\n      ,[DataSetName]\n      ,[SchemaName]\n      ,[TargetLake]\n      ,[ConnectionId]\n      ,[IsEnabled])\n\t\tSELECT * FROM dbo.tbdxxxxx;\nDROP TABLE dbo.tbdxxxxx\n\n\n\t\nEND\nGO\n\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "mesqldw",
				"databaseName": "mesqldw"
			}
		},
		"type": "SqlQuery"
	}
}