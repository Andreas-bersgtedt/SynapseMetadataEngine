{
	"name": "12_Metadata_sp_prime_Delta",
	"properties": {
		"folder": {
			"name": "Run Me 2nd"
		},
		"content": {
			"query": "CREATE PROC [Metadata].[sp_prime_Delta_Attribute] @EntityId [bigint],@DeltaColumn [VARCHAR](MAX),@DeltaOperator [VARCHAR](MAX),@DeltaSeedValue [VARCHAR](MAX) AS\nBEGIN\n\t/*\n--DEBUG\nDECLARE @EntityId bigint , @DeltaColumn VARCHAR(MAX), @RowIdColumn VARCHAR(MAX), @DeltaOperator VARCHAR(MAX), @DeltaSeedValue VARCHAR(MAX)\n\n\nSET @EntityId = 477\nSET  @RowIdColumn = 'rowguid'\nSET  @DeltaColumn = 'ModifiedDate'\nSET  @DeltaOperator = '>='\n--DEBUG\n*/\n\t/*DECLARE CONSTANTS*/\n\t--DECLARE @RIDKEY VARCHAR(MAX) = 'EntityRowIdentifier'\n\tDECLARE @DeltaColumnKEY VARCHAR(MAX) = 'EntityDeltaColumn'\n\tDECLARE @DeltaOperatorKEY VARCHAR(MAX) = 'EntityDeltaOperator'\n\tDECLARE @DeltaValueKEY VARCHAR(MAX) = 'EntityDeltaValue'\n\tDECLARE @DeltaValueTypeKEY VARCHAR(MAX) = 'EntityDeltaValueType'\n\t/*DECLARE GLOBALS*/\n\tDECLARE @DataSetID BIGINT\n\t\t,@DeltaDataType VARCHAR(MAX)\n\n\tSET @DataSetID = (\n\t\t\tSELECT DataSetID\n\t\t\tFROM [Metadata].[Entity]\n\t\t\tWHERE id = @EntityId\n\t\t\t)\n\t/*GET Metadata*/\n\tSET @DeltaDataType = (\n\t\t\tSELECT v.[Value]\n\t\t\tFROM [Metadata].[Attribute] v\n\t\t\tINNER JOIN [Metadata].[Object] o ON o.id = v.Objectid\n\t\t\t\tAND o.[MetadataObjectName] = @DeltaColumn\n\t\t\t\tAND v.[Key] = 'ObjectDataType'\n\t\t\t\tAND v.Entityid = @EntityId\n\t\t\t)\n\n\tDELETE\n\tFROM [Metadata].[Attribute]\n\tWHERE ID IN (\n\t\t\tSELECT v.id\n\t\t\tFROM [Metadata].[Attribute] v\n\t\t\tWHERE v.[Key] IN (\n\t\t\t\t\t@DeltaColumnKEY\n\t\t\t\t\t,@DeltaOperatorKEY\n\t\t\t\t\t,@DeltaValueKEY\n\t\t\t\t\t,@DeltaValueTypeKEY\n\t\t\t\t\t)\n\t\t\t\tAND v.Entityid = @EntityId\n\t\t\t)\n\n\tINSERT INTO [Metadata].[Attribute] (\n\t\t[EntityId]\n\t\t,[ObjectId]\n\t\t,[MetadataObjectHash]\n\t\t,[DataSetID]\n\t\t,[KEY]\n\t\t,[Value]\n\t\t,[KeyValueDataType]\n\t\t,[KeyValueRefreshDate]\n\t\t,[RecordProcessTimestamp]\n\t\t,[CreatedUTCTimestamp]\n\t\t)\n\tSELECT *\n\tFROM (\n\t\tSELECT [EntityId] = @EntityId\n\t\t\t,[ObjectId] = NULL\n\t\t\t,[MetadataObjectHash] = NULL\n\t\t\t,[DataSetID] = @DataSetID\n\t\t\t,[KEY] = @DeltaColumnKEY\n\t\t\t,[Value] = @DeltaColumn\n\t\t\t,[KeyValueDataType] = 'String'\n\t\t\t,[KeyValueRefreshDate] = getutcdate()\n\t\t\t,[RecordProcessTimestamp] = getutcdate()\n\t\t\t,[CreatedUTCTimestamp] = getutcdate()\n\t\t\n\t\tUNION ALL\n\t\t\n\t\tSELECT [EntityId] = @EntityId\n\t\t\t,[ObjectId] = NULL\n\t\t\t,[MetadataObjectHash] = NULL\n\t\t\t,[DataSetID] = @DataSetID\n\t\t\t,[KEY] = @DeltaOperatorKEY\n\t\t\t,[Value] = @DeltaOperator\n\t\t\t,[KeyValueDataType] = 'String'\n\t\t\t,[KeyValueRefreshDate] = getutcdate()\n\t\t\t,[RecordProcessTimestamp] = getutcdate()\n\t\t\t,[CreatedUTCTimestamp] = getutcdate()\n\t\t\n\t\tUNION ALL\n\t\t\n\t\tSELECT [EntityId] = @EntityId\n\t\t\t,[ObjectId] = NULL\n\t\t\t,[MetadataObjectHash] = NULL\n\t\t\t,[DataSetID] = @DataSetID\n\t\t\t,[KEY] = @DeltaValueKEY\n\t\t\t,[Value] = @DeltaSeedValue\n\t\t\t,[KeyValueDataType] = 'String'\n\t\t\t,[KeyValueRefreshDate] = getutcdate()\n\t\t\t,[RecordProcessTimestamp] = getutcdate()\n\t\t\t,[CreatedUTCTimestamp] = getutcdate()\n\t\t\n\t\tUNION ALL\n\t\t\n\t\tSELECT [EntityId] = @EntityId\n\t\t\t,[ObjectId] = NULL\n\t\t\t,[MetadataObjectHash] = NULL\n\t\t\t,[DataSetID] = @DataSetID\n\t\t\t,[KEY] = @DeltaValueTypeKEY\n\t\t\t,[Value] = @DeltaDataType\n\t\t\t,[KeyValueDataType] = 'String'\n\t\t\t,[KeyValueRefreshDate] = getutcdate()\n\t\t\t,[RecordProcessTimestamp] = getutcdate()\n\t\t\t,[CreatedUTCTimestamp] = getutcdate()\n\t\t) AS XX\n\n\tSELECT v.*\n\tFROM [Metadata].[Attribute] v\n\tWHERE v.[Key] IN (\n\t\t\t@DeltaColumnKEY\n\t\t\t,@DeltaOperatorKEY\n\t\t\t,@DeltaValueKEY\n\t\t\t,@DeltaValueTypeKEY\n\t\t\t)\n\t\tAND v.Entityid = @EntityId\nEND",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "Built-in",
				"databaseName": "master"
			}
		},
		"type": "SqlQuery"
	}
}