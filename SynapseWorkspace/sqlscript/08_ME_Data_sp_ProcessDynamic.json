{
	"name": "08_ME_Data_sp_ProcessDynamic",
	"properties": {
		"folder": {
			"name": "Run Me 2nd"
		},
		"content": {
			"query": "CREATE PROC [ME_Data].[sp_ProcessDynamicStagedMetadata] @DataSetType [VARCHAR](100) AS\nBEGIN\n--Initial Reset... \nBEGIN TRY \nDROP TABLE #TTAttribute\nDROP TABLE #TTBase\nDROP TABLE #TTOBJECT\nDROP TABLE #TTEntity\nDROP TABLE #Attribute\nDROP TABLE #OBJECT\nDROP TABLE #Entity\nEND TRY\nBEGIN CATCH\nPRINT 'Seems as if the temp tables were not there :)'\nEND CATCH\n\n\n\n\n--Lock In Reslults\nSELECT [MetadataQuerySource]\n      ,[MetadataEntityName]\n      ,[MetadataSchemaName]\n      ,[MetadataObjectName]\n      ,[MetadataObjectType]\n      ,[MetadataObjectlength]\n      ,[MetadataObjectPrecision]\n      ,[MetadataObjectScale]\n      ,[MetadataObjectCollation]\n      ,[DataSetID]\n      ,[MetadataObjectOrder]\n      ,[MetadataObjectIdentityFlag]\n      ,[MetadataObjectRefreshUTCTimeStamp]\n\n\t  ,MetadataObjectHash=CONVERT(BIGINT,HASHBYTES('SHA1',CONCAT([DataSetID],'¬'\n      ,[MetadataObjectName])))\n\t   \n\tINTO #TTBase\n\t--SELECT *\n  FROM [ME_Data].[MetadataEntityStage]\n  WHERE [MetadataQuerySource]='Dynamic' \n\t\tAND DATASETID IN\t(\n\t\t\t\t\t\t\tSELECT id \n\t\t\t\t\t\t\tfrom [ME_Config].[DataSet] \n\t\t\t\t\t\t\twhere @DataSetType=DataSetType\n\t\t\t\t\t\t\t)\n\n--Get All Distinct Entities\n--DROP TABLE #TTEntity\nSELECT DISTINCT [DataSetID],[MetadataEntityName]\n      ,[MetadataSchemaName]\nINTO #TTEntity\nFROM #TTBase\n\n--Build Up Objects\nSELECT [DataSetID]\n      ,[MetadataObjectName]\n\t  ,[MetadataObjectOrder]\n\t  ,MetadataObjectHash\n\t  ,[MetadataObjectRefreshUTCTimeStamp]=MAX([MetadataObjectRefreshUTCTimeStamp])\nINTO #TTOBJECT\nFROM #TTBase\nGROUP BY [DataSetID]\n      ,[MetadataObjectName]\n\t  ,MetadataObjectHash\n\t  ,[MetadataObjectOrder]\n\n\n--Build Attribute KVP Table\nSELECT *\nINTO #TTAttribute\nFROM (\nSELECT\t MetadataObjectHash\n\t\t,[DataSetID]\n\t\t,[KEY]=CONVERT(VARCHAR(100),'ObjectDataType')\n\t\t,[Value]=CONVERT(NVARCHAR(4000),[MetadataObjectType])\n\t\t,[KeyValueDataType]=CONVERT(VARCHAR(50),'String')\n\t\t,[KeyValueRefreshDate]=[MetadataObjectRefreshUTCTimeStamp]\nFROM #TTBase\nUNION ALL\nSELECT\t MetadataObjectHash\n\t\t,[DataSetID]\n\t\t,[KEY]=CONVERT(VARCHAR(100),'ObjectDataTypeSize')\n\t\t,[Value]=CONVERT(NVARCHAR(4000),MetadataObjectlength)\n\t\t,[KeyValueDataType]='Int'\n\t\t,[KeyValueRefreshDate]=[MetadataObjectRefreshUTCTimeStamp]\nFROM #TTBase\nUNION ALL\nSELECT\t MetadataObjectHash\n\t\t,[DataSetID]\n\t\t,[KEY]=CONVERT(VARCHAR(100),'ObjectDataTypePrecision')\n\t\t,[Value]=CONVERT(NVARCHAR(4000),MetadataObjectPrecision)\n\t\t,[KeyValueDataType]='Int'\n\t\t,[KeyValueRefreshDate]=[MetadataObjectRefreshUTCTimeStamp]\nFROM #TTBase\nUNION ALL\nSELECT\t MetadataObjectHash\n\t\t,[DataSetID]\n\t\t,[KEY]=CONVERT(VARCHAR(100),'ObjectDataTypeScale')\n\t\t,[Value]=CONVERT(NVARCHAR(4000),MetadataObjectScale)\n\t\t,[KeyValueDataType]='Int'\n\t\t,[KeyValueRefreshDate]=[MetadataObjectRefreshUTCTimeStamp]\nFROM #TTBase\nUNION ALL\nSELECT\t MetadataObjectHash\n\t\t,[DataSetID]\n\t\t,[KEY]=CONVERT(VARCHAR(100),'ObjectDataTypeCollation')\n\t\t,[Value]=CONVERT(NVARCHAR(4000),MetadataObjectCollation)\n\t\t,[KeyValueDataType]='String'\n\t\t,[KeyValueRefreshDate]=[MetadataObjectRefreshUTCTimeStamp]\nFROM #TTBase\nWHERE ISNULL(MetadataObjectCollation,'') !=''\nUNION ALL\nSELECT\t MetadataObjectHash\n\t\t,[DataSetID]\n\t\t,[KEY]=CONVERT(VARCHAR(100),'ObjectIdentityFlag')\n\t\t,[Value]=CONVERT(NVARCHAR(4000),MetadataObjectIdentityFlag)\n\t\t,[KeyValueDataType]='Int'\n\t\t,[KeyValueRefreshDate]=[MetadataObjectRefreshUTCTimeStamp]\nFROM #TTBase\n) X\n\n\n\nSELECT E.*,D.TargetLake,LakeFolder=CONCAT(D.id\n\t\t\t\t\t\t\t\t,'\\'\n\t\t\t\t\t\t\t\t,D.DataSetType\n\t\t\t\t\t\t\t\t,'\\'\n\t\t\t\t\t\t\t\t,E.[MetadataSchemaName]\n\t\t\t\t\t\t\t\t,'\\'\n\t\t\t\t\t\t\t\t,E.[MetadataEntityName]) \n\t\t,RecordProcessTimestamp=GETUTCDATE()\nINTO #Entity\nFROM #TTEntity E\nINNER JOIN [ME_Config].[DataSet] D ON D.id=E.DataSetID\n\nSELECT * ,RecordProcessTimestamp=GETUTCDATE()\nINTO #Object\nFROM #TTOBJECT\n\nSELECT * ,RecordProcessTimestamp=GETUTCDATE()\nINTO #Attribute\nFROM #TTAttribute\n\n\n--Update Metadata.Entity table\nUPDATE t\nSET \n       t.[Name]=s.[MetadataEntityName]\n      ,t.[SchemaName]=s.[MetadataSchemaName]\n      ,t.[TargetLake]=s.[TargetLake]\n      ,t.[LakeFolder]=s.[LakeFolder]\n      ,t.[RecordProcessTimestamp]=s.[RecordProcessTimestamp]\nFROM [Metadata].[Entity] t \nINNER JOIN  #Entity s ON s.[DataSetId] = t.[DataSetId]\n\n\n\tINSERT INTO [Metadata].[Entity] ([DataSetId]\n      ,[Name]\n      ,[SchemaName]\n      ,[TargetLake]\n      ,[LakeFolder]\n      ,[RecordProcessTimestamp]\n\t  ,CreatedUTCTimestamp)\n\t  SELECT DISTINCT s.[DataSetId]\n      ,s.[MetadataEntityName]\n      ,s.[MetadataSchemaName]\n      ,s.[TargetLake]\n      ,s.[LakeFolder]\n      ,s.[RecordProcessTimestamp]\n\t  ,CreatedUTCTimestamp=GETUTCDATE()\n\t  FROM #Entity s \n\t  LEFT OUTER JOIN  [Metadata].[Entity] t\n\t  ON s.[DataSetId] = t.[DataSetId]\n\t  WHERE t.[DataSetId] IS NULL\n\t;\n\t  /*\nMERGE [Metadata].[Entity] t \n    USING #Entity s\nON (s.[DataSetId] = t.[DataSetId])\nWHEN MATCHED\n    THEN UPDATE SET \n       t.[Name]=s.[MetadataEntityName]\n      ,t.[SchemaName]=s.[MetadataSchemaName]\n      ,t.[TargetLake]=s.[TargetLake]\n      ,t.[LakeFolder]=s.[LakeFolder]\n      ,t.[RecordProcessTimestamp]=s.[RecordProcessTimestamp]\n\n\n\n            \nWHEN NOT MATCHED --BY TARGET \n    THEN INSERT ([DataSetId]\n      ,[Name]\n      ,[SchemaName]\n      ,[TargetLake]\n      ,[LakeFolder]\n      ,[RecordProcessTimestamp])\n         VALUES (s.[DataSetId]\n      ,s.[MetadataEntityName]\n      ,s.[MetadataSchemaName]\n      ,s.[TargetLake]\n      ,s.[LakeFolder]\n      ,s.[RecordProcessTimestamp])\n\t  */\n\t;\n\n\t\n\n--Update Metadata Object Table \n\nUPDATE t\nSET \n        t.[MetadataObjectOrder]\t\t=s.[MetadataObjectOrder]\n       ,t.[RecordProcessTimestamp]\t=s.[RecordProcessTimestamp]\nFROM [Metadata].[Object] t \nINNER JOIN  (\n\t\t\tSELECT o.*, [EntityId]=E.id \n\t\t\tFROM #Object o \n\t\t\tINNER JOIN [Metadata].[Entity] E \n\t\t\tON E.[DataSetId]=o.[DataSetId]\n\t\t\t) s ON s.[MetadataObjectHash] = t.[MetadataObjectHash];\n\nINSERT INTO [Metadata].[Object]([EntityId]\n\t\t\t\t,[DataSetID]\n\t\t\t\t,[MetadataObjectName]\n\t\t\t\t,[MetadataObjectOrder]\n\t\t\t\t,[MetadataObjectHash]\n\t\t\t\t,[MetadataObjectRefreshUTCTimeStamp]\n\t\t\t\t,[RecordProcessTimestamp]\n\t\t\t\t,CreatedUTCTimestamp\n\t\t\t\t)\n         SELECT s.[EntityId]\n\t\t\t\t,s.[DataSetID]\n\t\t\t\t,s.[MetadataObjectName]\n\t\t\t\t,s.[MetadataObjectOrder]\n\t\t\t\t,s.[MetadataObjectHash]\n\t\t\t\t,s.[MetadataObjectRefreshUTCTimeStamp]\n\t\t\t\t,s.[RecordProcessTimestamp]\n\t\t\t\t,CreatedUTCTimestamp=GETUTCDATE()\n\tFROM   (\n\t\t\tSELECT o.*, [EntityId]=E.id \n\t\t\tFROM #Object o \n\t\t\tINNER JOIN [Metadata].[Entity] E \n\t\t\tON E.[DataSetId]=o.[DataSetId]\n\t\t\t) s \n\tWHERE s.[MetadataObjectHash] NOT IN (SELECT [MetadataObjectHash] FROM [Metadata].[Object] WITH (NOLOCK))\n\t\n\n\n/*\nMERGE [Metadata].[Object] t \n    USING\t(\n\t\t\tSELECT o.*, [EntityId]=E.id \n\t\t\tFROM #Object o \n\t\t\tINNER JOIN [Metadata].[Entity] E \n\t\t\tON E.[DataSetId]=o.[DataSetId]\n\t\t\t) s\nON (s.[MetadataObjectHash] = t.[MetadataObjectHash])\nWHEN MATCHED\n    THEN UPDATE SET \n       t.[MetadataObjectOrder]\t\t=s.[MetadataObjectOrder]\n       ,t.[RecordProcessTimestamp]\t=s.[RecordProcessTimestamp]\n            \nWHEN NOT MATCHED BY TARGET \n    THEN INSERT ([EntityId]\n\t\t\t\t,[DataSetID]\n\t\t\t\t,[MetadataObjectName]\n\t\t\t\t,[MetadataObjectOrder]\n\t\t\t\t,[MetadataObjectHash]\n\t\t\t\t,[MetadataObjectRefreshUTCTimeStamp]\n\t\t\t\t,[RecordProcessTimestamp]\n\t\t\t\t)\n         VALUES (s.[EntityId]\n\t\t\t\t,s.[DataSetID]\n\t\t\t\t,s.[MetadataObjectName]\n\t\t\t\t,s.[MetadataObjectOrder]\n\t\t\t\t,s.[MetadataObjectHash]\n\t\t\t\t,s.[MetadataObjectRefreshUTCTimeStamp]\n\t\t\t\t,s.[RecordProcessTimestamp])\n\t;\n\n\t*/\n\n--Update Metadata Attribute Table \n\nUPDATE t\nSET \n        t.[Value]=s.[Value]\n       ,t.[KeyValueRefreshDate]=s.[KeyValueRefreshDate]\n       ,t.[RecordProcessTimestamp]\t=s.[RecordProcessTimestamp]\nFROM [Metadata].[Attribute] t \nINNER JOIN  (\n\t\t\tSELECT o.*, [EntityId]=E.[EntityId] ,[ObjectId]=E.[Id] \n\t\t\tFROM #Attribute o \n\t\t\tINNER JOIN [Metadata].[Object] E \n\t\t\tON E.[MetadataObjectHash]=o.[MetadataObjectHash]\n\t\t\t) s ON (s.[MetadataObjectHash] = t.[MetadataObjectHash] and S.[Key]=T.[Key]);\n\n\nINSERT INTO [Metadata].[Attribute] ([EntityId]\n\t\t\t\t,[ObjectId]\n\t\t\t\t,[MetadataObjectHash]\n\t\t\t\t,[DataSetID]\n\t\t\t\t,[KEY]\n\t\t\t\t,[Value]\n\t\t\t\t,[KeyValueDataType]\n\t\t\t\t,[KeyValueRefreshDate]\n\t\t\t\t,[RecordProcessTimestamp]\n\t\t\t\t,CreatedUTCTimestamp\n\t\t\t\t)\n\t\t\tSELECT s.[EntityId]\n\t\t\t\t,s.[ObjectId]\n\t\t\t\t,s.[MetadataObjectHash]\n\t\t\t\t,s.[DataSetID]\n\t\t\t\t,s.[KEY]\n\t\t\t\t,s.[Value]\n\t\t\t\t,s.[KeyValueDataType]\n\t\t\t\t,s.[KeyValueRefreshDate]\n\t\t\t\t,s.[RecordProcessTimestamp]\n\t\t\t\t,CreatedUTCTimestamp=GETUTCDATE()\n\t\t\tFROM \n\t\t\t(\n\t\t\t\tSELECT o.*, [EntityId]=E.[EntityId] ,[ObjectId]=E.[Id] \n\t\t\t\tFROM #Attribute o \n\t\t\t\tINNER JOIN [Metadata].[Object] E \n\t\t\t\tON E.[MetadataObjectHash]=o.[MetadataObjectHash]\n\t\t\t) s \n\t\t\tLEFT OUTER JOIN [Metadata].[Attribute]  t ON s.[MetadataObjectHash] = t.[MetadataObjectHash] and S.[Key]=T.[Key] \n\t\t\tWHERE t.[MetadataObjectHash] IS NULL;\n/*\nMERGE [Metadata].[Attribute] t \n    USING\t(\n\t\t\tSELECT o.*, [EntityId]=E.[EntityId] ,[ObjectId]=E.[Id] \n\t\t\tFROM #Attribute o \n\t\t\tINNER JOIN [Metadata].[Object] E \n\t\t\tON E.[MetadataObjectHash]=o.[MetadataObjectHash]\n\t\t\t) s\nON (s.[MetadataObjectHash] = t.[MetadataObjectHash] and S.[Key]=T.[Key])\nWHEN MATCHED\n    THEN UPDATE SET \n\t\tt.[Value]=s.[Value]\n       ,t.[KeyValueRefreshDate]=s.[KeyValueRefreshDate]\n       ,t.[RecordProcessTimestamp]\t=s.[RecordProcessTimestamp]\n            \nWHEN NOT MATCHED BY TARGET \n    THEN INSERT ([EntityId]\n\t\t\t\t,[ObjectId]\n\t\t\t\t,[MetadataObjectHash]\n\t\t\t\t,[DataSetID]\n\t\t\t\t,[KEY]\n\t\t\t\t,[Value]\n\t\t\t\t,[KeyValueDataType]\n\t\t\t\t,[KeyValueRefreshDate]\n\t\t\t\t,[RecordProcessTimestamp]\n\t\t\t\t)\n         VALUES (s.[EntityId]\n\t\t\t\t,s.[ObjectId]\n\t\t\t\t,s.[MetadataObjectHash]\n\t\t\t\t,s.[DataSetID]\n\t\t\t\t,s.[KEY]\n\t\t\t\t,s.[Value]\n\t\t\t\t,s.[KeyValueDataType]\n\t\t\t\t,s.[KeyValueRefreshDate]\n\t\t\t\t,s.[RecordProcessTimestamp])\n\t;\n\t*/\n--Purge stage table of data\nDELETE  FROM [ME_Data].[MetadataEntityStage]\nWHERE CONVERT(BIGINT,HASHBYTES('SHA1',CONCAT([DataSetID],'¬'\n      ,[MetadataObjectName]))) IN (SELECT DISTINCT MetadataObjectHash FROM #TTBase)\n--Cleanup\nDROP TABLE #TTAttribute\nDROP TABLE #TTBase\nDROP TABLE #TTOBJECT\nDROP TABLE #TTEntity\nDROP TABLE #Attribute\nDROP TABLE #OBJECT\nDROP TABLE #Entity\n\nEND",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "mesqldw",
				"databaseName": "mesqldw"
			}
		},
		"type": "SqlQuery"
	}
}