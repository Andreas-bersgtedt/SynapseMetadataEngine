{
	"name": "04_ME_Data_sp_GetDynamic",
	"properties": {
		"folder": {
			"name": "Run Me 2nd"
		},
		"content": {
			"query": "CREATE PROC [ME_Data].[sp_GetDynamicMSSQLQuery] @DataSetType [VARCHAR] (100)\n\t,@ExecutionGroup [VARCHAR] (10)\n\t,@ExecutionPlane [VARCHAR] (10)\nAS\nBEGIN\n\tDECLARE @PARTITION VARCHAR(50)\n\n\tSET @PARTITION = (\n\t\t\tSELECT REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR(16), GETUTCDATE(), 120), '-', '\\'), ' ', '\\'), ':', '\\')\n\t\t\t)\n\n\tSELECT [DataSetType]\n\t\t,DBServerName\n\t\t,DBName\n\t\t,SQLKVName\n\t\t,SqlUserName\n\t\t,[DataSetName]\n\t\t,[SchemaName]\n\t\t,DLContainer\n\t\t,DLFolder = DLFolder + '\\' + @PARTITION\n\t\t,DLFileName\n\t\t,SQLQuery = CONVERT(NVARCHAR(MAX), 'SELECT ' + Cols + CASE \n\t\t\t\tWHEN [DataSetType] LIKE '%MSSQL'\n\t\t\t\t\tTHEN ' FROM [' + [SchemaName] + '].[' + [Name] + ']'\n\t\t\t\tWHEN [DataSetType] LIKE '%ORACLE'\n\t\t\t\t\tTHEN ' FROM \"' + [SchemaName] + '\".\"' + [Name] + '\"'\n\t\t\t\tELSE ' FROM `' + [SchemaName] + '`.`' + [Name] + '`'\n\t\t\t\tEND + WhereClause)\n\t\t,Cols\n\t\t,DataSetID = ID\n\t\t,[Target_Partition] = REPLACE(@PARTITION, '\\', '/')\n\tFROM (\n\t\tSELECT d.[DataSetType]\n\t\t\t,DBServerName = C.[ConnectionString]\n\t\t\t,DBName = C.[ConnectionName]\n\t\t\t,SQLKVName = C.[ConnectionKVSecret]\n\t\t\t,SqlUserName = C.[ConnetionUserName]\n\t\t\t,D.[DataSetName]\n\t\t\t,D.[SchemaName]\n\t\t\t,DLContainer = LOWER(E.TargetLake)\n\t\t\t,DLFolder = LOWER(E.LakeFolder)\n\t\t\t,DLFileName = LOWER(CONCAT (\n\t\t\t\t\tD.[SchemaName]\n\t\t\t\t\t,'_'\n\t\t\t\t\t,D.[DataSetName]\n\t\t\t\t\t))\n\t\t\t,E.[Name]\n\t\t\t,D.ID\n\t\t\t--\n\t\t\t,Cols = CONVERT(NVARCHAR(MAX), (\n\t\t\t\t\tISNULL(STRING_AGG((\n\t\t\t\t\t\t\t\tCASE \n\t\t\t\t\t\t\t\t\tWHEN d.[DataSetType] = 'MSSQL'\n\t\t\t\t\t\t\t\t\t\tTHEN '[' + o.[MetadataObjectName] + ']  AS [' + REPLACE(o.[MetadataObjectName], ' ', '_') + ']'\n\t\t\t\t\t\t\t\t\tWHEN d.[DataSetType] = 'ORACLE'\n\t\t\t\t\t\t\t\t\t\tTHEN '\"' + o.[MetadataObjectName] + '\"  AS \"' + REPLACE(o.[MetadataObjectName], ' ', '_') + '\"'\n\t\t\t\t\t\t\t\t\tELSE '`' + o.[MetadataObjectName] + '`  AS `' + REPLACE(o.[MetadataObjectName], ' ', '_') + '`'\n\t\t\t\t\t\t\t\t\tEND\n\t\t\t\t\t\t\t\t), ',') WITHIN GROUP (\n\t\t\t\t\t\t\tORDER BY o.[MetadataObjectOrder] ASC\n\t\t\t\t\t\t\t), '*')\n\t\t\t\t\t))\n\t\t\t,WhereClause = CASE \n\t\t\t\tWHEN DC.EntityID IS NULL\n\t\t\t\t\tTHEN ''\n\t\t\t\tELSE CONCAT (\n\t\t\t\t\t\t' Where '\n\t\t\t\t\t\t,' '\n\t\t\t\t\t\t,DC.WhereCol\n\t\t\t\t\t\t,' '\n\t\t\t\t\t\t,DC.WhereOperator\n\t\t\t\t\t\t,' '\n\t\t\t\t\t\t,DC.wherevalue\n\t\t\t\t\t\t,' '\n\t\t\t\t\t\t)\n\t\t\t\tEND\n\t\t--SELECT *\n\t\tFROM [Metadata].[Entity] E\n\t\tINNER JOIN [ME_Config].[DataSet] D ON D.id = e.datasetid\n\t\t\tAND D.[IsEnabled] = 1\n\t\t\tAND d.[DataSetType] LIKE @DataSetType\n\t\tINNER JOIN [ME_Config].[Connection] C ON D.CONNECTIONID = C.ID\n\t\tINNER JOIN [Metadata].[Object] o ON o.EntityID = E.id\n\t\tLEFT OUTER JOIN Metadata.DeltaConfig DC ON DC.EntityID = E.id\n\t\tGROUP BY d.[DataSetType]\n\t\t\t,C.[ConnectionString]\n\t\t\t,C.[ConnectionName]\n\t\t\t,C.[ConnectionKVSecret]\n\t\t\t,C.[ConnectionKVSecret]\n\t\t\t,D.[DataSetName]\n\t\t\t,D.[SchemaName]\n\t\t\t,LOWER(E.TargetLake)\n\t\t\t,LOWER(E.LakeFolder)\n\t\t\t,LOWER(CONCAT (\n\t\t\t\t\tD.[SchemaName]\n\t\t\t\t\t,'_'\n\t\t\t\t\t,D.[DataSetName]\n\t\t\t\t\t))\n\t\t\t,E.[Name]\n\t\t\t,D.ID\n\t\t\t,C.[ConnetionUserName]\n\t\t\t,CASE \n\t\t\t\tWHEN DC.EntityID IS NULL\n\t\t\t\t\tTHEN ''\n\t\t\t\tELSE CONCAT (\n\t\t\t\t\t\t' Where '\n\t\t\t\t\t\t,' '\n\t\t\t\t\t\t,DC.WhereCol\n\t\t\t\t\t\t,' '\n\t\t\t\t\t\t,DC.WhereOperator\n\t\t\t\t\t\t,' '\n\t\t\t\t\t\t,DC.wherevalue\n\t\t\t\t\t\t,' '\n\t\t\t\t\t\t)\n\t\t\t\tEND\n\t\t) AS X\nEND",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "mesqldw",
				"databaseName": "mesqldw"
			}
		},
		"type": "SqlQuery"
	}
}